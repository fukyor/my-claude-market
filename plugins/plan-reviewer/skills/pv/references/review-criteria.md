# 计划审查准则

本文档提供详细的审查准则和检查清单，用于系统性评估技术实施计划。

## 审查维度

### 1. 代码库深度验证（核心维度）

**目标**：结合代码库，验证计划中的代码逻辑是否正确、设计是否冗余

#### 1.1 现有代码理解
- [ ] 是否已读取计划涉及的所有文件的相关代码段？
- [ ] 是否理解了现有代码的数据流和控制流？
- [ ] 是否理解了现有代码的错误处理和并发模式？

#### 1.2 代码一致性验证
- [ ] 计划中引用的结构体/类定义是否与代码库一致？（字段名、类型、tag）
- [ ] 计划中引用的函数签名是否与代码库一致？（参数、返回值）
- [ ] 计划中指定的文件路径和行号是否准确？
- [ ] 计划中"现有代码"的引用是否反映了代码库的最新状态？

#### 1.3 逻辑融合正确性
- [ ] 新代码插入现有控制流后，整体逻辑是否仍然正确？
- [ ] 新增的状态变更是否会破坏现有的不变量（invariant）？
- [ ] 新增的错误处理是否与现有模式一致？（如：现有代码返回error，计划代码是否也返回error而非panic？）
- [ ] 新增的并发操作是否与现有的锁/同步机制兼容？

#### 1.4 设计冗余性评估
- [ ] 计划中的新代码是否与现有代码存在大量重复？
  - 使用 Grep 搜索相似的代码模式和关键词
  - 如果计划说"参考XXX的实现"，必须读取XXX并对比相似度
- [ ] 是否应该提取公共函数而非复制粘贴？
- [ ] 如果选择复制，计划是否说明了合理理由？
- [ ] 新增的抽象层/接口/结构体是否可以用现有的替代？
- [ ] 是否创建了现有工具/库已能完成的功能？

**修复模式**：
```
发现：计划说"参考ConnectHTTPMitm的实现，结构完全一致"
验证：读取ConnectHTTPMitm的代码，对比新函数的代码
结果：如果相似度>70%，质疑是否应提取公共函数，或要求计划说明复制的理由
```

---

### 2. 冗余检查

**目标**：识别并消除不必要的重复操作

**检查项**：
- [ ] 是否有重复的代码修改步骤？
  - 同一文件被多次修改且内容相关
- [ ] 是否有不必要的中间变量/步骤？
  - 直接A→B即可，无需A→C→B
- [ ] 是否有可以合并的操作？
  - 多个小改动可合并为一次大改动
- [ ] 是否创建了现有工具已能完成的功能？
- [ ] 计划中的新代码是否与现有代码存在大量重复？（与1.4互补，侧重步骤层面）

**常见冗余模式**：
```
冗余：
1. 修改文件A添加函数f1
2. 修改文件A添加函数f2
3. 修改文件A添加函数f3

优化：
1. 修改文件A，一次性添加f1/f2/f3
```

---

### 3. 逻辑正确性

**目标**：确保实施步骤在逻辑上可行且正确

**检查项**：
- [ ] 步骤依赖关系是否合理？
  - 前置条件是否已满足
- [ ] 是否存在循环依赖？
  - A依赖B，B又依赖A
- [ ] 数据流是否连贯？
  - 输出是否匹配下一步的输入
- [ ] 控制流是否完整？
  - 是否有遗漏的分支处理
- [ ] 边界条件是否考虑？（注：与"4.4 输入验证Bug-参数范围"互补，侧重流程层面）
  - 空值、最大值、最小值

**逻辑错误模式**：
```
错误：先使用函数，再定义函数
错误：修改API调用方，但不修改API本身
错误：假设数据格式，但不验证
```

---

### 4. 潜在Bug识别

**目标**：提前发现可能导致bug的设计问题

#### 4.1 状态管理Bug
- [ ] 是否有未处理的状态转换？（注：与"3. 逻辑正确性-控制流"互补，侧重状态机层面）
- [ ] 异常情况下状态是否一致？
- [ ] 是否有竞态条件可能？

#### 4.2 资源管理Bug
- [ ] 文件/连接是否正确关闭？
- [ ] 内存是否有泄漏风险？
- [ ] 是否有资源未释放的情况？

#### 4.3 错误处理Bug
- [ ] 所有错误路径是否都有处理？
- [ ] 错误信息是否足够调试？
- [ ] 是否有静默失败的可能？

#### 4.4 输入验证Bug
- [ ] 外部输入是否验证？
- [ ] 参数范围是否检查？（注：与"3. 逻辑正确性-边界条件"互补，侧重代码层面）
- [ ] 类型是否验证？

#### 4.5 并发Bug
- [ ] 共享状态是否有保护？
- [ ] 是否有死锁可能？
- [ ] 原子操作是否正确？

---

### 5. 架构合理性

**目标**：确保计划符合良好的架构原则

**检查项**：
- [ ] 模块职责是否单一？
- [ ] 接口是否清晰？
- [ ] 是否遵循现有代码风格？
- [ ] 扩展性如何？
- [ ] 测试覆盖是否考虑？

---

### 6. 代码一致性验证

**目标**：确保计划中引用的代码与当前代码库一致（独立于1.2，专注于计划内部引用的完整性）

**检查项**：
- [ ] 计划中引用的结构体/类定义是否与代码库一致？
- [ ] 计划中引用的函数签名是否与代码库一致？
- [ ] 计划中指定的文件路径和行号是否准确？
- [ ] 计划中引用的变量/常量是否存在且类型正确？
- [ ] 计划中"现有代码"的引用是否反映了代码库的最新状态？

---

### 7. 计划可执行性

**目标**：确保计划可以按步骤顺利执行

**检查项**：
- [ ] 步骤间是否有明确的执行顺序？
- [ ] 前面步骤的修改是否会影响后续步骤的行号引用？
- [ ] 计划中的代码片段是否可以直接复制粘贴使用？
- [ ] 是否有遗漏的 import 语句？
- [ ] 新增的函数/方法是否有完整的签名（参数、返回值）？
- [ ] 计划中的"保留原有代码"注释是否清晰标注了保留范围？
- [ ] 步骤间的命名是否一致？（同一新增元素在不同步骤中名称是否相同）

---

## 审查报告模板

```markdown
## 审查摘要
- 计划文件：[文件名]
- 审查时间：[时间戳]
- 严重问题：[数量]个
- 优化建议：[数量]条

## 问题清单

### [严重程度] [类别]：[问题描述]
**位置**：计划第X行
**影响**：[具体影响]
**建议**：[修复方案]

## 优化建议

### [优化项]
**当前方案**：[描述]
**优化方案**：[描述]
**收益**：[说明]

## 修订计划

[完整的修订后计划]
```

## 审查优先级

| 优先级 | 类型 | 说明 |
|--------|------|------|
| P0 | 阻塞性问题 | 必须修复，否则计划无法执行 |
| P1 | 严重缺陷 | 很可能导致bug或重大问题 |
| P2 | 优化建议 | 可提升质量或效率 |
| P3 | 风格建议 | 代码风格一致性改进 |
